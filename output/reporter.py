"""
æŠ¥å‘Šç”Ÿæˆå™¨ - å¤šç§è¾“å‡ºæ ¼å¼æ”¯æŒ
"""
import json
from datetime import datetime
from pathlib import Path
from typing import Any, List

from core.analyzer import ScanResult, Vulnerability, Severity


class ReportGenerator:
    """æŠ¥å‘Šç”Ÿæˆå™¨"""

    def __init__(self, result: ScanResult):
        self.result = result

    def to_json(self, pretty: bool = True) -> str:
        """ç”Ÿæˆ JSON æ ¼å¼æŠ¥å‘Š"""
        data = self._build_report_data()
        if pretty:
            return json.dumps(data, indent=2, ensure_ascii=False)
        return json.dumps(data, ensure_ascii=False)

    def to_text(self, verbose: bool = False) -> str:
        """ç”Ÿæˆäººç±»å¯è¯»çš„æ–‡æœ¬æŠ¥å‘Š"""
        lines = [
            "=" * 60,
            "ğŸ”’ CodeSentry å®‰å…¨æ‰«ææŠ¥å‘Š",
            "=" * 60,
            f"ğŸ“‚ ç›®æ ‡: {self.result.target}",
            f"ğŸ“Š æ–‡ä»¶æ•°: {self.result.total_files}",
            f"ğŸ“ ä»£ç è¡Œæ•°: {self.result.total_lines}",
            f"â±ï¸  æ‰«æè€—æ—¶: {self.result.scan_time_seconds:.2f}ç§’",
            "",
            "ğŸ“ˆ æ¼æ´ç»Ÿè®¡:",
            f"  ğŸ”´ Critical: {self.result.critical_count}",
            f"  ğŸŸ  High: {self.result.high_count}",
            f"  ğŸŸ¡ Medium: {self.result.medium_count}",
            f"  ğŸŸ¢ Low: {self.result.low_count}",
            "",
        ]

        if self.result.vulnerabilities:
            severity_order = [
                Severity.CRITICAL, Severity.HIGH,
                Severity.MEDIUM, Severity.LOW, Severity.INFO
            ]

            for severity in severity_order:
                vulns = [v for v in self.result.vulnerabilities if v.severity == severity]
                if not vulns:
                    continue

                icon = {
                    Severity.CRITICAL: "ğŸ”´",
                    Severity.HIGH: "ğŸŸ ",
                    Severity.MEDIUM: "ğŸŸ¡",
                    Severity.LOW: "ğŸŸ¢",
                    Severity.INFO: "ğŸ”µ",
                }[severity]

                lines.append(f"\n{icon} {severity.value.upper()} æ¼æ´ ({len(vulns)}):")
                lines.append("-" * 60)

                for i, vuln in enumerate(vulns, 1):
                    lines.append(f"\n{i}. {vuln.title}")
                    lines.append(f"   ğŸ“ ä½ç½®: {vuln.location}")
                    lines.append(f"   ğŸ·ï¸  ç±»å‹: {vuln.type.value} ({vuln.cwe_id})")
                    lines.append(f"   ğŸ¯ ç½®ä¿¡åº¦: {vuln.confidence:.0%}")

                    if vuln.ai_verified:
                        lines.append(f"   âœ… AI éªŒè¯: å·²ç¡®è®¤")

                    if vuln.ai_analysis:
                        lines.append(f"   ğŸ“ AI åˆ†æ: {vuln.ai_analysis}")

                    if vuln.fix_suggestion:
                        lines.append(f"   ğŸ’¡ ä¿®å¤å»ºè®®: {vuln.fix_suggestion}")

                    lines.append("```")
                    lines.append(vuln.code_snippet)
                    lines.append("```")

        if self.result.errors:
            lines.extend([
                "",
                "âš ï¸ æ‰«æè¿‡ç¨‹ä¸­çš„é”™è¯¯:",
                "\n".join(f"  - {e}" for e in self.result.errors[:10]),
            ])

        lines.extend([
            "",
            "=" * 60,
            f"æŠ¥å‘Šç”Ÿæˆæ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}",
            "Generated by CodeSentry - AI-Powered Code Security Auditor",
            "=" * 60,
        ])

        return "\n".join(lines)

    def _build_report_data(self) -> dict[str, Any]:
        """æ„å»ºæŠ¥å‘Šæ•°æ®"""
        return {
            "scan_info": {
                "target": self.result.target,
                "timestamp": datetime.now().isoformat(),
                "total_files": self.result.total_files,
                "total_lines": self.result.total_lines,
                "scan_time_seconds": self.result.scan_time_seconds,
            },
            "statistics": {
                "critical": self.result.critical_count,
                "high": self.result.high_count,
                "medium": self.result.medium_count,
                "low": self.result.low_count,
                "total": len(self.result.vulnerabilities),
            },
            "vulnerabilities": [
                {
                    "id": v.id,
                    "type": v.type.name,
                    "severity": v.severity.value,
                    "title": v.title,
                    "description": v.description,
                    "location": {
                        "file": v.location.file,
                        "line": v.location.line,
                    },
                    "cwe_id": v.cwe_id,
                    "confidence": v.confidence,
                    "ai_verified": v.ai_verified,
                    "ai_analysis": v.ai_analysis,
                    "ai_verification_result": v.ai_verification_result,
                    "fix_suggestion": v.fix_suggestion,
                    "code_snippet": v.code_snippet,
                }
                for v in self.result.vulnerabilities
            ],
            "errors": self.result.errors,
        }

    def save(self, output_path: str, format: str = "text"):
        """ä¿å­˜æŠ¥å‘Šåˆ°æ–‡ä»¶"""
        path = Path(output_path)
        path.parent.mkdir(parents=True, exist_ok=True)

        if format == "json":
            content = self.to_json()
        else:
            content = self.to_text()

        with open(path, "w", encoding="utf-8") as f:
            f.write(content)

        print(f"âœ… æŠ¥å‘Šå·²ä¿å­˜åˆ°: {output_path}")
        return path
